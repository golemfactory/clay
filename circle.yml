machine:
  services:
    - docker

checkout:
  post:
    - git submodule update --init

dependencies:
  pre:
    - sudo apt-get install -y python-qt4
    - if [ ! -e /home/ubuntu/virtualenvs/venv-system/lib/python2.7/site-packages/PyQt4 ]; then ln -s /usr/lib/python2.7/dist-packages/PyQt4/ /home/ubuntu/virtualenvs/venv-system/lib/python2.7/site-packages/; ln -s /usr/lib/python2.7/dist-packages/sip.so /home/ubuntu/virtualenvs/venv-system/lib/python2.7/site-packages/; ln -s /usr/lib/python2.7/dist-packages/sip.x86_64-linux-gnu.so /home/ubuntu/virtualenvs/venv-system/lib/python2.7/site-packages/; fi
    - if [ ! -e /usr/local/bin/ipfs ]; then wget http://dist.ipfs.io/go-ipfs/v0.4.1/go-ipfs_v0.4.1_linux-amd64.tar.gz; tar xvfz go-ipfs_v0.4.1_linux-amd64.tar.gz; sudo mv go-ipfs/ipfs /usr/local/bin/ipfs; /usr/local/bin/ipfs init; fi
    - /usr/local/bin/ipfs config --json Bootstrap "[]"
    - /usr/local/bin/ipfs config --json SupernodeRouting.Servers "[]"
    - /usr/local/bin/ipfs config --json Addresses.Swarm '["/ip6/::/tcp/4001", "/ip6/::/udp/4002/utp", "/ip4/0.0.0.0/udp/4002/utp"]'
    - /usr/local/bin/ipfs daemon:
        background: true
    - sudo add-apt-repository -y ppa:ethereum/ethereum && sudo apt-get update && sudo apt-get install geth
    - geth --nodiscover --maxpeers 0 --exec "miner.makeDAG(0)" console
    - if [[ -e ~/docker/golem_base.tar ]]; then docker load -i ~/docker/golem_base.tar; fi
    - if [[ -e ~/docker/golem_blender.tar ]]; then docker load -i ~/docker/golem_blender.tar; fi
    - if [[ -e ~/docker/golem_luxrender.tar ]]; then docker load -i ~/docker/golem_luxrender.tar; fi
  post:
    - mkdir -p ~/docker
    - if [[ ! -e ~/docker/golem_base.tar ]]; then docker save golem/base > ~/docker/golem_base.tar; fi
    - if [[ ! -e ~/docker/golem_blender.tar ]]; then docker save golem/blender > ~/docker/golem_blender.tar; fi
    - if [[ ! -e ~/docker/golem_luxrender.tar ]]; then docker save golem/luxrender > ~/docker/golem_luxrender.tar; fi
  cache_directories:
    - ~/.ethash
    - ~/docker

test:
  pre:
    - pip install coverage codecov
  override:
    - coverage run --branch --source=. setup.py test -a "--junitxml=$CIRCLE_TEST_REPORTS/test_result.xml":
        timeout: 1200
  post:
    - codecov
